using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Web;
using System.Web.Http;
using Newtonsoft.Json;
using SqlUtilityCore;

namespace SqlUtilityWeb.Controller
{
    public class WebApiController : ApiController
    {
        private void LoadTestData(MsSqlUtility msSqlUtility)
        {
            msSqlUtility.RemoveAllTableSchema();
            msSqlUtility.AddTableSchema("<xsd:schema xmlns:schema=\"urn: schemas - microsoft - com:sql: SqlRowSet4\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:sqltypes=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes\" targetNamespace=\"urn:schemas-microsoft-com:sql:SqlRowSet4\" elementFormDefault=\"qualified\"><xsd:import namespace=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes\" schemaLocation=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes/sqltypes.xsd\" /><xsd:element name=\"AdventureWorksDW2012.dbo.DimProduct\"><xsd:complexType><xsd:attribute name=\"ProductKey\" type=\"sqltypes:int\" use=\"required\" /><xsd:attribute name=\"ProductAlternateKey\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"25\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"ProductSubcategoryKey\" type=\"sqltypes:int\" /><xsd:attribute name=\"WeightUnitMeasureCode\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"3\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"SizeUnitMeasureCode\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"3\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"EnglishProductName\" use=\"required\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"SpanishProductName\" use=\"required\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"FrenchProductName\" use=\"required\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"StandardCost\" type=\"sqltypes:money\" /><xsd:attribute name=\"FinishedGoodsFlag\" type=\"sqltypes:bit\" use=\"required\" /><xsd:attribute name=\"Color\" use=\"required\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"15\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"SafetyStockLevel\" type=\"sqltypes:smallint\" /><xsd:attribute name=\"ReorderPoint\" type=\"sqltypes:smallint\" /><xsd:attribute name=\"ListPrice\" type=\"sqltypes:money\" /><xsd:attribute name=\"Size\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"SizeRange\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"Weight\" type=\"sqltypes:float\" /><xsd:attribute name=\"DaysToManufacture\" type=\"sqltypes:int\" /><xsd:attribute name=\"ProductLine\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"2\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"DealerPrice\" type=\"sqltypes:money\" /><xsd:attribute name=\"Class\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"2\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"Style\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"2\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"ModelName\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"LargePhoto\" type=\"sqltypes:dbobject\" /><xsd:attribute name=\"EnglishDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"FrenchDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1036\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"ChineseDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"2052\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreNonSpace IgnoreKanaType IgnoreWidth\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"ArabicDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1025\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"HebrewDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1037\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"ThaiDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1054\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"GermanDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlCollationVersion=\"2\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"JapaneseDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1041\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"TurkishDescription\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1055\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\"><xsd:maxLength value=\"400\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"StartDate\" type=\"sqltypes:datetime\" /><xsd:attribute name=\"EndDate\" type=\"sqltypes:datetime\" /><xsd:attribute name=\"Status\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"7\" /></xsd:restriction></xsd:simpleType></xsd:attribute></xsd:complexType></xsd:element></xsd:schema>");
            msSqlUtility.AddTableSchema("<xsd:schema xmlns:schema=\"urn:schemas-microsoft-com:sql:SqlRowSet5\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:sqltypes=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes\" targetNamespace=\"urn:schemas-microsoft-com:sql:SqlRowSet5\" elementFormDefault=\"qualified\"><xsd:import namespace=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes\" schemaLocation=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes/sqltypes.xsd\" /><xsd:element name=\"AdventureWorksDW2012.dbo.DimProductCategory\"><xsd:complexType><xsd:attribute name=\"ProductCategoryKey\" type=\"sqltypes:int\" use=\"required\" /><xsd:attribute name=\"ProductCategoryAlternateKey\" type=\"sqltypes:int\" /><xsd:attribute name=\"EnglishProductCategoryName\" use=\"required\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"SpanishProductCategoryName\" use=\"required\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute><xsd:attribute name=\"FrenchProductCategoryName\" use=\"required\"><xsd:simpleType><xsd:restriction base=\"sqltypes:nvarchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"IgnoreCase IgnoreKanaType IgnoreWidth\" sqltypes:sqlSortId=\"52\"><xsd:maxLength value=\"50\" /></xsd:restriction></xsd:simpleType></xsd:attribute></xsd:complexType></xsd:element></xsd:schema>");
        }

        //StreamReader reader = new StreamReader(HttpContext.Current.Request.InputStream);
        //string requestFromPost = reader.ReadToEnd();
        //User entity = JsonConvert.DeserializeObject<User>(requestFromPost.Replace("'", "\'"));

        [HttpGet]
        [ActionName("GetTables")]
        public object GetTables()
        {
            MsSqlUtility msSqlUtility = (MsSqlUtility)HttpContext.Current.Application[HttpContext.Current.Request.Headers["sessionId"]];
            LoadTestData(msSqlUtility);
            return msSqlUtility.GetAllTableSchema();
        }

        [HttpGet]
        [ActionName("EndSession")]
        public bool EndSession()
        {
            string sessionId = HttpContext.Current.Request.Headers["sessionId"];
            if (!string.IsNullOrEmpty(sessionId))
            {
                HttpContext.Current.Application.Remove(sessionId);
            }
            return true;
        }
    }
}